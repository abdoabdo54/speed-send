#!/bin/bash

echo "========================================"
echo "üî• FORCE UPDATING SERVER WITH FIXES"
echo "========================================"
echo ""

cd /opt/speed-send || exit 1

echo "1Ô∏è‚É£ Pulling latest code..."
git pull origin main

echo ""
echo "2Ô∏è‚É£ Stopping all services..."
docker-compose down

echo ""
echo "3Ô∏è‚É£ Removing all containers and images..."
docker-compose rm -f
docker rmi speed-send-backend speed-send-frontend 2>/dev/null || true

echo ""
echo "4Ô∏è‚É£ Rebuilding backend with no cache..."
docker-compose build --no-cache backend

echo ""
echo "5Ô∏è‚É£ Rebuilding frontend with no cache..."
docker-compose build --no-cache frontend

echo ""
echo "6Ô∏è‚É£ Starting all services..."
docker-compose up -d

echo ""
echo "7Ô∏è‚É£ Waiting for services to start..."
sleep 20

echo ""
echo "8Ô∏è‚É£ Checking service status..."
docker-compose ps

echo ""
echo "9Ô∏è‚É£ Testing backend health..."
curl -s http://localhost:8000/health && echo "‚úÖ Backend OK" || echo "‚ùå Backend not ready"

echo ""
echo "üîü Testing launch endpoint..."
curl -s -X POST http://localhost:8000/api/v1/campaigns/1/launch || echo "‚ùå Launch endpoint not ready"

echo ""
echo "========================================"
echo "‚úÖ SERVER FORCE UPDATED!"
echo "========================================"
echo ""
echo "üéØ FIXES APPLIED:"
echo "   ‚úÖ WorkspaceUser import added"
echo "   ‚úÖ Launch endpoint fixed"
echo "   ‚úÖ Delete endpoint added"
echo "   ‚úÖ Duplicate endpoint added"
echo ""
echo "üåê Test at: http://172.236.219.75:3000/campaigns"
echo ""
